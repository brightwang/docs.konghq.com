---
name: Kong Upstream HMAC
publisher: brightwang

categories:
  - security

type: plugin

desc: This plugin will add HMAC Signature authentication into the HTTP Header Authorization to upstream service request.

support_url: https://github.com/brightwang/kong-upstream-hmac/issues

source_url: https://github.com/brightwang/kong-upstream-hmac

license_type: Apache-2.0

kong_version_compatibility:
  community_edition:
    compatible:
      - 1.0.x

params:
  name: kong-upstream-hmac
  api_id: true
  service_id: true
  consumer_id: false
  route_id: true
  config:
    - name: validate_request_body
      required: false
      default: "`false`"
      description: A boolean value telling the plugin to enable body validation
        

extra: |
  Installing this plugin globally will ensure security across all proxies for service providers who implement the HMAC validation correctly.
###############################################################################
# END YAML DATA
# Beneath the next --- use Markdown (redcarpet flavor) and HTML formatting only.
#
# The remainder of this file is for free-form description, instruction, and
# reference matter.
# Your headers must be Level 3 or 4 (parsing to h3 or h4 tags in HTML).
# This is represented by ### or #### notation preceding the header text.
###############################################################################
# BEGIN MARKDOWN CONTENT
---

### Installation

Recommended:

```bash
$ luarocks install kong-upstream-hmac
```

Other:

```bash
$ git clone https://github.com/brightwang/kong-upstream-hmac.git /path/to/kong/plugins/kong-upstream-hmac
$ cd /path/to/kong/plugins/kong-upstream-hmac
$ luarocks make *.rockspec
```

### Caveat
This plugin reference to [hmac-auth](https://docs.konghq.com/hub/kong-inc/hmac-auth/)

### Signature Authentication Scheme

The client is expected to send an `Authorization` header
with the following parameterization:

```
credentials := "hmac" params
params := keyId "," algorithm ", " headers ", " signature
keyId := "username" "=" plain-string
algorithm := "algorithm" "=" DQUOTE (hmac-sha1) DQUOTE
headers := "headers" "=" plain-string
signature := "signature" "=" plain-string
plain-string   = DQUOTE *( %x20-21 / %x23-5B / %x5D-7E ) DQUOTE
```

### Signature Parameters

parameter| description
---       | ---
username  | The `username` of the credential
algorithm | Digital signature algorithm used to create the signature.only support hmac-sha1.
headers   | List of HTTP header names, separated by a single space character, used to sign the request.Default is 'date request-line'. when config.validate_request_body=true then 'digest date request-line'
signature | `Base64` encoded digital signature generated by the client

### Signature String Construction

In order to generate the string that is signed with a key, the client
MUST take the values of each HTTP header specified by `headers` in
the order they appear.

1. If the header name is not `request-line` then append the
  lowercased header name followed with an ASCII colon `:` and an
  ASCII space ` `.

2. If the header name is `request-line` then append the HTTP
  request line (in ASCII format), otherwise append the header value.

3. If value is not the last value then append an ASCII newline `\n`.
  The string MUST NOT include a trailing ASCII newline.

### Body Validation

User can set `config.validate_request_body` as `true` to validate the request
body. If it's enabled the plugin will calculate the `SHA-256` HMAC digest of
the request body and match it against the value of the `Digest` header. The
Digest header needs to be in following format:

```
Digest: SHA-256=base64(sha256(<body>))
```

If there is no request body, the `Digest` should be set to the digest of a
body of 0 length.

Note: In order to create the digest of a request body, the plugin needs to
retain it in memory, which might cause pressure on the worker's Lua VM when
dealing with large bodies (several MBs) or during high request concurrency.


### Configuration

```bash
curl -X POST http://kong:8001/routes/{route-id}/plugins -d "name=kong-upstream-hmac" -d "config.token=token" -d "config.secret=secret"
```

#### 

### Maintainers

[brightwang](https://github.com/brightwang)  

Feel free to [open issues](https://github.com/brightwang/kong-upstream-hmac/issues)